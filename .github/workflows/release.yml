name: Release Erebus

permissions:
  contents: write  # æˆäºˆ Release ç›¸å…³æƒé™ï¼ˆåˆ›å»º Releaseã€ä¸Šä¼ èµ„äº§ï¼‰
  actions: read    # å¯é€‰ï¼šè¯»å–å·¥ä½œæµçŠ¶æ€ï¼ˆæŒ‰éœ€æ·»åŠ ï¼‰

on:
  push:
    tags:
      - 'v*'  # æ¨é€ v å¼€å¤´æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ v1.0.0ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ

env:
  APP_NAME: erebus       # é¡¹ç›®åç§°ï¼ˆä¸ Makefile ä¿æŒä¸€è‡´ï¼‰
  CONFIG_DIR: etc        # é…ç½®æ–‡ä»¶ç›®å½•

jobs:
  # å¤šå¹³å°æ„å»ºä¸æ‰“åŒ…ä½œä¸š
  build-and-package:
    name: Build for ${{ matrix.platform.name }}
    runs-on: ${{ matrix.platform.runner }}
    strategy:
      # ç¡®ä¿æ¯ä¸ªå¹³å°ç‹¬ç«‹æ„å»ºï¼Œä¸€ä¸ªå¹³å°å¤±è´¥ä¸å½±å“å…¶ä»–
      fail-fast: false
      matrix:
        platform:
          - name: linux-amd64
            runner: ubuntu-latest
            goos: linux
            goarch: amd64
            archive_format: tar.gz
          - name: linux-arm64
            runner: ubuntu-latest
            goos: linux
            goarch: arm64
            archive_format: tar.gz
          - name: windows-amd64
            runner: windows-latest
            goos: windows
            goarch: amd64
            archive_format: zip
            binary_ext: .exe  # Windows äºŒè¿›åˆ¶åç¼€
          - name: darwin-amd64
            runner: macos-latest
            goos: darwin
            goarch: amd64
            archive_format: tar.gz
          - name: darwin-arm64
            runner: macos-latest
            goos: darwin
            goarch: arm64
            archive_format: tar.gz

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ç¡®ä¿èƒ½è·å– Git æ ‡ç­¾ï¼ˆç”¨äºç‰ˆæœ¬å·ï¼‰

      # 2. é…ç½® Go ç¯å¢ƒ
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'  # ä¸é¡¹ç›® Go ç‰ˆæœ¬ä¿æŒä¸€è‡´
          cache: true         # ç¼“å­˜ Go ä¾èµ–ï¼ŒåŠ é€Ÿæ„å»º
          cache-dependency-path: go.sum  # ä¾èµ–ç¼“å­˜è·¯å¾„

      # 3. è°ƒç”¨ Makefile æ„å»ºï¼ˆä¾èµ–é¡¹ç›®æ ¹ç›®å½•çš„ Makefile é…ç½®ï¼‰
      - name: Build with Makefile
        env:
          GOOS: ${{ matrix.platform.goos }}
          GOARCH: ${{ matrix.platform.goarch }}
          CGO_ENABLED: 0  # ç¦ç”¨ CGOï¼Œç¡®ä¿é™æ€ç¼–è¯‘ï¼ˆè·¨å¹³å°å…¼å®¹ï¼‰
        run: make

      # 4. éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆLinux/macOS ä¸“ç”¨ï¼‰
      - name: Verify binary (Linux/macOS)
        if: matrix.platform.goos != 'windows'
        run: |
          BINARY="${{ env.APP_NAME }}${{ matrix.platform.binary_ext || '' }}"
          # æ£€æŸ¥äºŒè¿›åˆ¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "$BINARY" ]; then
            echo "Error: Binary file '$BINARY' not found!"
            ls -la  # åˆ—å‡ºç›®å½•å†…å®¹ï¼Œè¾…åŠ©æ’æŸ¥é—®é¢˜
            exit 1
          fi
          # éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶ç±»å‹
          file "$BINARY"
          # æ·»åŠ å¯æ‰§è¡Œæƒé™
          chmod +x "$BINARY"
          echo "Binary verification passed: $BINARY"

      # 5. éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆWindows ä¸“ç”¨ï¼‰
      - name: Verify binary (Windows)
        if: matrix.platform.goos == 'windows'
        run: |
          $binary = "${{ env.APP_NAME }}${{ matrix.platform.binary_ext || '' }}"
          # æ£€æŸ¥äºŒè¿›åˆ¶æ˜¯å¦å­˜åœ¨ï¼ˆPowerShell è¯­æ³•ï¼‰
          if (-not (Test-Path $binary -PathType Leaf)) {
            Write-Error "Binary file '$binary' not found!"
            Get-ChildItem  # åˆ—å‡ºç›®å½•å†…å®¹ï¼Œè¾…åŠ©æ’æŸ¥é—®é¢˜
            exit 1
          }
          # éªŒè¯æ–‡ä»¶ä¿¡æ¯
          Get-Item $binary
          Write-Host "Binary verification passed: $binary"

      # 6. åˆ›å»ºæ‰“åŒ…ç›®å½•ä¸å¤åˆ¶æ–‡ä»¶ï¼ˆLinux/macOS ä¸“ç”¨ï¼‰
      - name: Create package (Linux/macOS)
        if: matrix.platform.goos != 'windows'
        run: |
          # å®šä¹‰æ‰“åŒ…ç›®å½•åï¼ˆæ ¼å¼ï¼šé¡¹ç›®å_ç‰ˆæœ¬_å¹³å°ï¼‰
          PACKAGE_DIR="${{ env.APP_NAME }}_${{ github.ref_name }}_${{ matrix.platform.name }}"
          # åˆ›å»ºç›®å½•ï¼ˆå«é…ç½®å­ç›®å½•ï¼‰
          mkdir -p "$PACKAGE_DIR/${{ env.CONFIG_DIR }}"
          
          # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
          BINARY="${{ env.APP_NAME }}${{ matrix.platform.binary_ext || '' }}"
          cp "$BINARY" "$PACKAGE_DIR/"
          chmod +x "$PACKAGE_DIR/$BINARY"
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶ï¼ˆå¿½ç•¥ç›®å½•ä¸å­˜åœ¨çš„æƒ…å†µï¼‰
          if [ -d "${{ env.CONFIG_DIR }}" ]; then
            cp -r "${{ env.CONFIG_DIR }}"/* "$PACKAGE_DIR/${{ env.CONFIG_DIR }}/" 2>/dev/null || true
          fi
          
          # åˆ›å»º README è¯´æ˜æ–‡ä»¶ï¼ˆUnix è¯­æ³•ï¼‰
          cat > "$PACKAGE_DIR/README.txt" << EOF
          Erebus ${{ github.ref_name }} - ${{ matrix.platform.name }}
          
          ä¸€ã€åŒ…å«æ–‡ä»¶
            - $BINARY: ä¸»ç¨‹åºå¯æ‰§è¡Œæ–‡ä»¶
            - ${{ env.CONFIG_DIR }}/: é…ç½®æ–‡ä»¶ç›®å½•ï¼ˆå«é»˜è®¤é…ç½®ï¼‰
          
          äºŒã€è¿è¡Œæ–¹å¼
            1. è¿›å…¥æ‰“åŒ…ç›®å½•ï¼šcd $PACKAGE_DIR
            2. æ‰§è¡Œç¨‹åºï¼š./$BINARY
            3. ï¼ˆå¯é€‰ï¼‰æŒ‡å®šé…ç½®æ–‡ä»¶ï¼š./$BINARY -config ${{ env.CONFIG_DIR }}/erebus.yaml
          
          ä¸‰ã€ç‰ˆæœ¬ä¿¡æ¯
            - æ ‡ç­¾ç‰ˆæœ¬ï¼š${{ github.ref_name }}
            - æ„å»ºå¹³å°ï¼š${{ matrix.platform.name }}
            - Go ç‰ˆæœ¬ï¼š1.21
          EOF
          echo "Package created: $PACKAGE_DIR"

      # 7. åˆ›å»ºæ‰“åŒ…ç›®å½•ä¸å¤åˆ¶æ–‡ä»¶ï¼ˆWindows ä¸“ç”¨ï¼Œè§£å†³å˜é‡è§£æå†²çªï¼‰
      - name: Create package (Windows)
        if: matrix.platform.goos == 'windows'
        run: |
          # å®šä¹‰å˜é‡ï¼ˆPowerShell è¯­æ³•ï¼‰
          $packageDir = "${{ env.APP_NAME }}_${{ github.ref_name }}_${{ matrix.platform.name }}"
          $binary = "${{ env.APP_NAME }}${{ matrix.platform.binary_ext || '' }}"
          $configDir = "${{ env.CONFIG_DIR }}"
          $tagVersion = "${{ github.ref_name }}"
          $platformName = "${{ matrix.platform.name }}"
          
          # åˆ›å»ºç›®å½•ï¼ˆå¼ºåˆ¶åˆ›å»ºï¼Œå¿½ç•¥å·²å­˜åœ¨ï¼‰
          New-Item -ItemType Directory -Path "$packageDir\$configDir" -Force | Out-Null
          
          # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆå¼ºåˆ¶è¦†ç›–ï¼‰
          Copy-Item -Path $binary -Destination "$packageDir\" -Force
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶ï¼ˆç›®å½•å­˜åœ¨æ‰å¤åˆ¶ï¼‰
          if (Test-Path $configDir -PathType Container) {
            Copy-Item -Path "$configDir\*" -Destination "$packageDir\$configDir\" -Recurse -Force
          }
          
          # ç”Ÿæˆ README å†…å®¹ï¼ˆç”¨å•å¼•å· Here-String é¿å…å˜é‡è§£æå†²çªï¼‰
          $readmeContent = @'
          Erebus {0} - {1}
          
          ä¸€ã€åŒ…å«æ–‡ä»¶
            - {2}: ä¸»ç¨‹åºå¯æ‰§è¡Œæ–‡ä»¶
            - {3}\: é…ç½®æ–‡ä»¶ç›®å½•ï¼ˆå«é»˜è®¤é…ç½®ï¼‰
          
          äºŒã€è¿è¡Œæ–¹å¼
            1. è¿›å…¥æ‰“åŒ…ç›®å½•ï¼šcd {0}
            2. æ‰§è¡Œç¨‹åºï¼š.\{2}
            3. ï¼ˆå¯é€‰ï¼‰æŒ‡å®šé…ç½®æ–‡ä»¶ï¼š.\{2} -config {3}\erebus.yaml
          
          ä¸‰ã€ç‰ˆæœ¬ä¿¡æ¯
            - æ ‡ç­¾ç‰ˆæœ¬ï¼š{0}
            - æ„å»ºå¹³å°ï¼š{1}
            - Go ç‰ˆæœ¬ï¼š1.21
          '@ -f $tagVersion, $platformName, $binary, $configDir
          
          # å†™å…¥ README æ–‡ä»¶ï¼ˆUTF-8 ç¼–ç ï¼Œç¡®ä¿ä¸­æ–‡æ­£å¸¸æ˜¾ç¤ºï¼‰
          Set-Content -Path "$packageDir\README.txt" -Value $readmeContent -Encoding UTF8
          Write-Host "Package created: $packageDir"

      # -------------------------- ä¿®å¤æ ¸å¿ƒï¼šæ‹†åˆ†å‹ç¼©æ­¥éª¤ --------------------------
      # 8. ç”Ÿæˆå‹ç¼©åŒ…ï¼ˆLinux/macOS ä¸“ç”¨ï¼Œbash è¯­æ³•ï¼‰
      - name: Create archive (Linux/macOS)
        if: matrix.platform.goos != 'windows'
        run: |
          # å®šä¹‰å‹ç¼©åŒ…åç§°ä¸è·¯å¾„
          PACKAGE_DIR="${{ env.APP_NAME }}_${{ github.ref_name }}_${{ matrix.platform.name }}"
          ARCHIVE_NAME="${{ env.APP_NAME }}_${{ github.ref_name }}_${{ matrix.platform.name }}.${{ matrix.platform.archive_format }}"
          
          # Linux/macOS ç”¨ tar å‹ç¼©ï¼ˆä¿ç•™æƒé™ï¼‰
          tar -czf "$ARCHIVE_NAME" "$PACKAGE_DIR"
          
          # è¾“å‡ºå‹ç¼©åŒ…ä¿¡æ¯ï¼ˆä¾›åç»­æ­¥éª¤ä½¿ç”¨ï¼‰
          echo "ARCHIVE_PATH=$ARCHIVE_NAME" >> $GITHUB_ENV
          echo "PACKAGE_DIR=$PACKAGE_DIR" >> $GITHUB_ENV
          echo "Archive created: $ARCHIVE_NAME (size: $(du -sh $ARCHIVE_NAME | cut -f1))"

      # 9. ç”Ÿæˆå‹ç¼©åŒ…ï¼ˆWindows ä¸“ç”¨ï¼ŒPowerShell è¯­æ³•ï¼‰
      - name: Create archive (Windows)
        if: matrix.platform.goos == 'windows'
        run: |
          # å®šä¹‰å˜é‡ï¼ˆPowerShell è¯­æ³•ï¼‰
          $packageDir = "${{ env.APP_NAME }}_${{ github.ref_name }}_${{ matrix.platform.name }}"
          $archiveName = "${{ env.APP_NAME }}_${{ github.ref_name }}_${{ matrix.platform.name }}.${{ matrix.platform.archive_format }}"
          
          # Windows ç”¨ 7z å‹ç¼©ï¼ˆæ˜ç¡®æŒ‡å®š zip æ ¼å¼ï¼‰
          7z a -tzip $archiveName "$packageDir\*"
          
          # è¾“å‡ºå‹ç¼©åŒ…ä¿¡æ¯ï¼ˆä¾›åç»­æ­¥éª¤ä½¿ç”¨ï¼ŒPowerShell ç¯å¢ƒå˜é‡è®¾ç½®æ–¹å¼ï¼‰
          echo "ARCHIVE_PATH=$archiveName" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          echo "PACKAGE_DIR=$packageDir" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          # è®¡ç®—å‹ç¼©åŒ…å¤§å°ï¼ˆPowerShell è¯­æ³•ï¼‰
          $archiveSize = (Get-Item $archiveName).Length / 1MB
          Write-Host "Archive created: $archiveName (size: $($archiveSize.ToString('0.00')) MB)"

      # --------------------------------------------------------------------------

      # 10. ä¸Šä¼ å‹ç¼©åŒ…ä¸º Artifactï¼ˆä¾¿äºåç»­å‘å¸ƒï¼‰
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-${{ matrix.platform.name }}  # Artifact åç§°ï¼ˆå¹³å°å”¯ä¸€ï¼‰
          path: ${{ env.ARCHIVE_PATH }}                         # å‹ç¼©åŒ…è·¯å¾„
          retention-days: 1                                    # ä¿ç•™ 1 å¤©ï¼ˆå‘å¸ƒåå¯åˆ é™¤ï¼‰
          if-no-files-found: error                             # æ— æ–‡ä»¶æ—¶æŠ¥é”™

  # åˆ›å»º GitHub Releaseï¼ˆä»…åœ¨æ„å»ºå®Œæˆåæ‰§è¡Œï¼‰
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-and-package  # ä¾èµ– build-and-package ä½œä¸šå®Œæˆ
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}  # ä¼ é€’ä¸Šä¼ åœ°å€ç»™åç»­æ­¥éª¤
    steps:
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHub è‡ªåŠ¨æ³¨å…¥çš„ Tokenï¼ˆæ— éœ€æ‰‹åŠ¨é…ç½®ï¼‰
        with:
          tag_name: ${{ github.ref_name }}          # æ ‡ç­¾åï¼ˆä¸è§¦å‘æ ‡ç­¾ä¸€è‡´ï¼‰
          release_name: Erebus ${{ github.ref_name }}  # å‘å¸ƒåç§°
          draft: false                               # ä¸åˆ›å»ºè‰ç¨¿ï¼ˆç›´æ¥å‘å¸ƒï¼‰
          prerelease: false                          # ä¸æ ‡è®°ä¸ºé¢„å‘å¸ƒï¼ˆæ­£å¼ç‰ˆæœ¬ï¼‰
          # å‘å¸ƒæè¿°ï¼ˆMarkdown æ ¼å¼ï¼‰
          body: |
            ## Erebus ${{ github.ref_name }} æ­£å¼å‘å¸ƒ
            
            ### ğŸ“¦ ä¸‹è½½é“¾æ¥
            - [Linux AMD64](${erebus_${{ github.ref_name }}_linux-amd64.tar.gz})
            - [Linux ARM64](${erebus_${{ github.ref_name }}_linux-arm64.tar.gz})
            - [Windows AMD64](${erebus_${{ github.ref_name }}_windows-amd64.zip})
            - [macOS AMD64](${erebus_${{ github.ref_name }}_darwin-amd64.tar.gz})
            - [macOS ARM64](${erebus_${{ github.ref_name }}_darwin-arm64.tar.gz})
            
            ### ğŸ“‹ åŒ…å«å†…å®¹
            æ¯ä¸ªå‹ç¼©åŒ…åŒ…å«ï¼š
            - ä¸»ç¨‹åºï¼ˆerebus æˆ– erebus.exeï¼‰
            - é…ç½®æ–‡ä»¶ç›®å½•ï¼ˆetc/ï¼Œå«é»˜è®¤é…ç½®ï¼‰
            - README.txtï¼ˆè¯¦ç»†ä½¿ç”¨è¯´æ˜ï¼‰
            
            ### ğŸ”§ è¿è¡Œè¦æ±‚
            - Go è¿è¡Œæ—¶ï¼šæ— éœ€ï¼ˆé™æ€ç¼–è¯‘ï¼‰
            - ç³»ç»Ÿæ¶æ„ï¼šå¯¹åº”å¹³å°æ¶æ„ï¼ˆå¦‚ Windows AMD64 éœ€ 64 ä½ç³»ç»Ÿï¼‰
            - æƒé™ï¼šæ‰§è¡Œæƒé™ï¼ˆLinux/macOS éœ€ chmod +xï¼‰
            
            ### ğŸ“ ç‰ˆæœ¬è¯´æ˜
            - æ„å»ºæ—¶é—´ï¼š${{ github.event.head_commit.timestamp }}
            - ä»£ç æäº¤ï¼š${{ github.event.head_commit.id }}
            - æ„å»ºç¯å¢ƒï¼šGitHub Actions

  # ä¸Šä¼ å‹ç¼©åŒ…åˆ° GitHub Releaseï¼ˆå¯¹åº”æ¯ä¸ªå¹³å°ï¼‰
  upload-to-release:
    name: Upload ${{ matrix.platform.name }} to Release
    runs-on: ubuntu-latest
    needs: [create-release, build-and-package]  # ä¾èµ–å‰ä¸¤ä¸ªä½œä¸šå®Œæˆ
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: linux-amd64
            archive_format: tar.gz
          - name: linux-arm64
            archive_format: tar.gz
          - name: windows-amd64
            archive_format: zip
          - name: darwin-amd64
            archive_format: tar.gz
          - name: darwin-arm64
            archive_format: tar.gz
    steps:
      # ä¸‹è½½ä¹‹å‰ä¸Šä¼ çš„ Artifactï¼ˆå‹ç¼©åŒ…ï¼‰
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-${{ matrix.platform.name }}  # ä¸ä¸Šä¼ æ—¶çš„ Artifact åç§°ä¸€è‡´
          path: ./artifacts  # ä¸‹è½½åˆ° artifacts ç›®å½•

      # ä¸Šä¼ å‹ç¼©åŒ…åˆ° GitHub Release
      - name: Upload to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}  # ä» create-release ä½œä¸šè·å–ä¸Šä¼ åœ°å€
          asset_path: ./artifacts/${{ env.APP_NAME }}_${{ github.ref_name }}_${{ matrix.platform.name }}.${{ matrix.platform.archive_format }}  # å‹ç¼©åŒ…è·¯å¾„
          asset_name: ${{ env.APP_NAME }}_${{ github.ref_name }}_${{ matrix.platform.name }}.${{ matrix.platform.archive_format }}  # æ˜¾ç¤ºåœ¨ Release ä¸Šçš„æ–‡ä»¶å
          asset_content_type: application/octet-stream  # äºŒè¿›åˆ¶æ–‡ä»¶ç±»å‹ï¼ˆé€šç”¨ï¼‰